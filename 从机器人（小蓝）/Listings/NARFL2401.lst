C51 COMPILER V9.59.0.0   NARFL2401                                                         07/16/2024 15:05:21 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE NARFL2401
OBJECT MODULE PLACED IN .\Objects\NARFL2401.obj
COMPILER INVOKED BY: G:\Keil_v5\C51\BIN\C51.EXE NARFL2401.c OMF2 OPTIMIZE(8,SPEED) BROWSE DEBUG PRINT(.\Listings\NARFL24
                    -01.lst) TABS(2) OBJECT(.\Objects\NARFL2401.obj)

line level    source

   1          # include "NARFL2401.h"
   2          #define  uint16   unsigned int  
   3          #define  uint8    unsigned char
   4           unsigned char cmd; 
   5          //ÎŞÏßÊÕ·¢µØÖ·¿í¶È(×Ö½ÚÊı)
   6          #define TX_ADDR_WIDTH 5
   7          #define RX_ADDR_WIDTH 5
   8          
   9          //ÎŞÏßÊÕ·¢Êı¾İ³¤¶È(×Ö½ÚÊı)
  10          #define TX_PLOAD_WIDTH 1
  11          #define RX_PLOAD_WIDTH 1
  12          
  13          #define SPIF 0x80 //SPSTAT.7
  14          #define WCOL 0x40 //SPSTAT.6
  15          #define SSIG 0x80 //SPCTL.7
  16          #define SPEN 0x40 //SPCTL.6
  17          #define DORD 0x20 //SPCTL.5
  18          #define MSTR 0x10 //SPCTL.4
  19          #define CPOL 0x08 //SPCTL.3
  20          #define CPHA 0x04 //SPCTL.2
  21          #define SPDHH 0x00 //CPU_CLK/4
  22          #define SPDH 0x01 //CPU_CLK/8
  23          #define SPDL 0x02 //CPU_CLK/16
  24          #define SPDLL 0x03 //CPU_CLK/32
  25          
  26          /****************************************************************************************************/
  27          //NRF24L01¼Ä´æÆ÷²Ù×÷ÃüÁî
  28          #define SPI_READ_REG    0x00  //¶ÁÅäÖÃ¼Ä´æÆ÷,µÍ5Î»Îª¼Ä´æÆ÷µØÖ·
  29          #define SPI_WRITE_REG   0x20  //Ğ´ÅäÖÃ¼Ä´æÆ÷,µÍ5Î»Îª¼Ä´æÆ÷µØÖ·
  30          #define RD_RX_PLOAD     0x61  //¶ÁRXÓĞĞ§Êı¾İ,1~32×Ö½Ú
  31          #define WR_TX_PLOAD     0xA0  //Ğ´TXÓĞĞ§Êı¾İ,1~32×Ö½Ú
  32          #define FLUSH_TX        0xE1  //Çå³ıTX FIFO¼Ä´æÆ÷.·¢ÉäÄ£Ê½ÏÂÓÃ
  33          #define FLUSH_RX        0xE2  //Çå³ıRX FIFO¼Ä´æÆ÷.½ÓÊÕÄ£Ê½ÏÂÓÃ
  34          #define REUSE_TX_PL     0xE3  //ÖØĞÂÊ¹ÓÃÉÏÒ»°üÊı¾İ,CEÎª¸ß,Êı¾İ°ü±»²»¶Ï·¢ËÍ.
  35          //#define NOP             0xFF  //¿Õ²Ù×÷,¿ÉÒÔÓÃÀ´¶Á×´Ì¬¼Ä´æÆ÷  
  36          //SPI(NRF24L01)¼Ä´æÆ÷µØÖ·
  37          #define CONFIG          0x00  //ÅäÖÃ¼Ä´æÆ÷µØÖ·;bit0:1½ÓÊÕÄ£Ê½,0·¢ÉäÄ£Ê½;bit1:µçÑ¡Ôñ;bit2:CRCÄ£Ê½;bit3:CRCÊ
             -¹ÄÜ;
  38                                        //bit4:ÖĞ¶ÏMAX_RT(´ïµ½×î´óÖØ·¢´ÎÊıÖĞ¶Ï)Ê¹ÄÜ;bit5:ÖĞ¶ÏTX_DSÊ¹ÄÜ;bit6:ÖĞ¶ÏRX_D
             -RÊ¹ÄÜ
  39          #define EN_AA           0x01  //Ê¹ÄÜ×Ô¶¯Ó¦´ğ¹¦ÄÜ  bit0~5,¶ÔÓ¦Í¨µÀ0~5
  40          #define EN_RXADDR       0x02  //½ÓÊÕµØÖ·ÔÊĞí,bit0~5,¶ÔÓ¦Í¨µÀ0~5
  41          #define SETUP_AW        0x03  //ÉèÖÃµØÖ·¿í¶È(ËùÓĞÊı¾İÍ¨µÀ):bit1,0:00,3×Ö½Ú;01,4×Ö½Ú;02,5×Ö½Ú;
  42          #define SETUP_RETR      0x04  //½¨Á¢×Ô¶¯ÖØ·¢;bit3:0,×Ô¶¯ÖØ·¢¼ÆÊıÆ÷;bit7:4,×Ô¶¯ÖØ·¢ÑÓÊ± 250*x+86us
  43          #define RF_CH           0x05  //RFÍ¨µÀ,bit6:0,¹¤×÷Í¨µÀÆµÂÊ;
  44          #define RF_SETUP        0x06  //RF¼Ä´æÆ÷;bit3:´«ÊäËÙÂÊ(0:1Mbps,1:2Mbps);bit2:1,·¢Éä¹¦ÂÊ;bit0:µÍÔëÉù·Å´óÆ÷Ô
             -öÒæ
  45          #define STATUS          0x07  //×´Ì¬¼Ä´æÆ÷;bit0:TX FIFOÂú±êÖ¾;bit3:1,½ÓÊÕÊı¾İÍ¨µÀºÅ(×î´ó:6);bit4,´ïµ½×î¶à´
             -ÎÖØ·¢
  46                                        //bit5:Êı¾İ·¢ËÍÍê³ÉÖĞ¶Ï;bit6:½ÓÊÕÊı¾İÖĞ¶Ï;
  47          #define MAX_TX        0x10    //´ïµ½×î´ó·¢ËÍ´ÎÊıÖĞ¶Ï
  48          #define TX_OK         0x20    //TX·¢ËÍÍê³ÉÖĞ¶Ï
  49          #define RX_OK         0x40    //½ÓÊÕµ½Êı¾İÖĞ¶Ï
  50          
C51 COMPILER V9.59.0.0   NARFL2401                                                         07/16/2024 15:05:21 PAGE 2   

  51          #define OBSERVE_TX      0x08  //·¢ËÍ¼ì²â¼Ä´æÆ÷,bit7:4,Êı¾İ°ü¶ªÊ§¼ÆÊıÆ÷;bit3:0,ÖØ·¢¼ÆÊıÆ÷
  52          #define CD              0x09  //ÔØ²¨¼ì²â¼Ä´æÆ÷,bit0,ÔØ²¨¼ì²â;
  53          #define RX_ADDR_P0      0x0A  //Êı¾İÍ¨µÀ0½ÓÊÕµØÖ·,×î´ó³¤¶È5¸ö×Ö½Ú,µÍ×Ö½ÚÔÚÇ°
  54          #define RX_ADDR_P1      0x0B  //Êı¾İÍ¨µÀ1½ÓÊÕµØÖ·,×î´ó³¤¶È5¸ö×Ö½Ú,µÍ×Ö½ÚÔÚÇ°
  55          #define RX_ADDR_P2      0x0C  //Êı¾İÍ¨µÀ2½ÓÊÕµØÖ·,×îµÍ×Ö½Ú¿ÉÉèÖÃ,¸ß×Ö½Ú,±ØĞëÍ¬RX_ADDR_P1[39:8]ÏàµÈ;
  56          #define RX_ADDR_P3      0x0D  //Êı¾İÍ¨µÀ3½ÓÊÕµØÖ·,×îµÍ×Ö½Ú¿ÉÉèÖÃ,¸ß×Ö½Ú,±ØĞëÍ¬RX_ADDR_P1[39:8]ÏàµÈ;
  57          #define RX_ADDR_P4      0x0E  //Êı¾İÍ¨µÀ4½ÓÊÕµØÖ·,×îµÍ×Ö½Ú¿ÉÉèÖÃ,¸ß×Ö½Ú,±ØĞëÍ¬RX_ADDR_P1[39:8]ÏàµÈ;
  58          #define RX_ADDR_P5      0x0F  //Êı¾İÍ¨µÀ5½ÓÊÕµØÖ·,×îµÍ×Ö½Ú¿ÉÉèÖÃ,¸ß×Ö½Ú,±ØĞëÍ¬RX_ADDR_P1[39:8]ÏàµÈ;
  59          #define TX_ADDR         0x10  //·¢ËÍµØÖ·(µÍ×Ö½ÚÔÚÇ°),ShockBurstTMÄ£Ê½ÏÂ,RX_ADDR_P0Óë´ËµØÖ·ÏàµÈ
  60          #define RX_PW_P0        0x11  //½ÓÊÕÊı¾İÍ¨µÀ0ÓĞĞ§Êı¾İ¿í¶È(1~32×Ö½Ú),ÉèÖÃÎª0Ôò·Ç·¨
  61          #define RX_PW_P1        0x12  //½ÓÊÕÊı¾İÍ¨µÀ1ÓĞĞ§Êı¾İ¿í¶È(1~32×Ö½Ú),ÉèÖÃÎª0Ôò·Ç·¨
  62          #define RX_PW_P2        0x13  //½ÓÊÕÊı¾İÍ¨µÀ2ÓĞĞ§Êı¾İ¿í¶È(1~32×Ö½Ú),ÉèÖÃÎª0Ôò·Ç·¨
  63          #define RX_PW_P3        0x14  //½ÓÊÕÊı¾İÍ¨µÀ3ÓĞĞ§Êı¾İ¿í¶È(1~32×Ö½Ú),ÉèÖÃÎª0Ôò·Ç·¨
  64          #define RX_PW_P4        0x15  //½ÓÊÕÊı¾İÍ¨µÀ4ÓĞĞ§Êı¾İ¿í¶È(1~32×Ö½Ú),ÉèÖÃÎª0Ôò·Ç·¨
  65          #define RX_PW_P5        0x16  //½ÓÊÕÊı¾İÍ¨µÀ5ÓĞĞ§Êı¾İ¿í¶È(1~32×Ö½Ú),ÉèÖÃÎª0Ôò·Ç·¨
  66          #define FIFO_STATUS     0x17  //FIFO×´Ì¬¼Ä´æÆ÷;bit0,RX FIFO¼Ä´æÆ÷¿Õ±êÖ¾;bit1,RX FIFOÂú±êÖ¾;bit2,3,±£Áô
  67                                        //bit4,TX FIFO¿Õ±êÖ¾;bit5,TX FIFOÂú±êÖ¾;bit6,1,Ñ­»··¢ËÍÉÏÒ»Êı¾İ°ü.0,²»Ñ­»·;
  68                                        
  69          #define CE_MA_LOW        en=0                        
  70          #define CE_MA_HIGH       en=1
  71          
  72          #define CS_MA_LOW        SPI_CS=0
  73          #define CS_MA_HIGH       SPI_CS=1
  74                                        
  75          const uint8 TX_ADDRESS[TX_ADDR_WIDTH]={0xE1,0xE2,0xE3,0xE4,0xE5}; //·¢ËÍµØÖ·
  76          const uint8 RX_ADDRESS[RX_ADDR_WIDTH]={0xE1,0xE2,0xE3,0xE4,0xE5}; //½ÓÊÕµØÖ·  
  77          uint8  RxPayload[1];   //ÎŞÏß½ÓÊÕ»º´æ
  78          uint8  TxPayload[1];   //ÎŞÏß·¢ËÍ»º´æ
  79          
  80          /**********************
  81          Òı½Å±ğÃû¶¨Òå
  82          ***********************/  
  83          sbit led_r=P0^5;      //¿ª·¢°åÓÃÓÚÎŞÏß½ÓÊÕÖ¸Ê¾µÆ 
  84          sbit IRQ=P3^3;        //ÖĞ¶Ï 
  85          sbit en= P3^4;         //Ê¹ÄÜ¿ØÖÆ
  86          sbit SPI_CS=P1^2;     //Æ¬Ñ¡ 
  87          //³õÊ¼»¯SPI//
  88          void InitSPI(void)
  89          {
  90   1        SPDAT = 0;                                        //³õÊ¼»¯SPIÊı¾İ
  91   1        SPSTAT = SPIF | WCOL;                             //Çå³ıSPI×´Ì¬Î»
  92   1        SPCTL = SPEN | MSTR | SSIG;                       //Ö÷»úÄ£Ê½
  93   1      }
  94          //NRF24L01³õÊ¼»¯º¯Êı£¬³õÊ¼»¯Á¬½ÓNRF24L01Ä£¿éµÄ¹Ü½Å
  95          //µ÷ÓÃSPI³õÊ¼»¯º¯ÊıÍê³ÉºÍNRF24L01Ä£¿éÍ¨Ñ¶µÄSPI×ÜÏßµÄ³õÊ¼»¯
  96          void Init_NRF24L01_MA(void)
  97          { 
  98   1        delay_ms(2);
  99   1        led_r=0;                                          //³õÊ¼»¯µãÁÁÍ¨ĞÅÖ¸Ê¾µÆ
 100   1        CE_MA_LOW;                                        //Ê¹ÄÜNRF24L01
 101   1        CS_MA_HIGH;                                       //SPIÆ¬Ñ¡È¡Ïû
 102   1        InitSPI();                                        //³õÊ¼»¯SPI
 103   1      }
 104          // Ä£ÄâSPI¶ÁĞ´Êı¾İº¯Êı£¬¶ÁĞ´Ò»¸ö×Ö½Ú
 105          //Èë  ²Î : Ğ´ÈëµÄÊı¾İ                                            ·µ»ØÖµ : ¶ÁÈ¡µÄÊı¾İ
 106          uint8 SPI_RW(uint8 byte)
 107          {
 108   1        SPDAT = byte;                                                 //´¥·¢SPI·¢ËÍÊı¾İ
 109   1        while (!(SPSTAT & SPIF));                                     //µÈ´ı·¢ËÍÍê³É
 110   1        SPSTAT = SPIF | WCOL;                                         //Çå³ıSPI×´Ì¬Î»
 111   1        return SPDAT;                                                 //·µ»ØSPIÊı¾İ
 112   1      }
C51 COMPILER V9.59.0.0   NARFL2401                                                         07/16/2024 15:05:21 PAGE 3   

 113          //***************************************************************************
 114          // ÏòÖ¸¶¨µØÖ·Ğ´ÈëÖ¸¶¨³¤¶ÈµÄÊı¾İ
 115          // Èë  ²Î : pBuf:¶Á³öÊı¾İµÄ´æ·ÅµØÖ·£»datlen£º¶Á³öµÄÊı¾İ×Ö½ÚÊı     ·µ»ØÖµ :·µ»Ø×´Ì¬¼Ä´æÆ÷Öµ
 116          uint8 NRF24L01_MA_Write_Buf(uint8 regaddr, uint8 *pBuf, uint8 datalen)
 117          {
 118   1        uint8 status,u8_ctr;      
 119   1        CS_MA_LOW;                                              //Ê¹ÄÜSPI´«Êä
 120   1        status = SPI_RW(regaddr);  
 121   1        for(u8_ctr=0; u8_ctr<datalen; u8_ctr++)
 122   1        {
 123   2          SPI_RW(*pBuf++); //Ğ´ÈëÊı¾İ   
 124   2        }
 125   1        CS_MA_HIGH;                                             //¹Ø±ÕSPI´«Êä
 126   1        return status;                                          //·µ»Ø¶Áµ½µÄ×´Ì¬Öµ
 127   1      } 
 128          ///***************************************************************************
 129          //NRF24L01¼Ä´æÆ÷Ğ´º¯Êı
 130          //Èë  ²Î : regaddr£ºÒªĞ´µÄ¼Ä´æÆ÷µØÖ·£»data£ºĞ´Èëµ½¼Ä´æÆ÷µÄÊı¾İ    ·µ»ØÖµ : ¶ÁÈ¡µÄ×´Ì¬Öµ
 131          uint8 NRF24L01_MA_Write_Reg(uint8 regaddr,uint8 dat)
 132          {
 133   1        uint8 status; 
 134   1        CS_MA_LOW;  
 135   1        status =SPI_RW(regaddr); 
 136   1        SPI_RW(dat);                           //Ğ´Èë¼Ä´æÆ÷µÄÖµ
 137   1        CS_MA_HIGH;                            //½ûÖ¹SPI´«Êä  
 138   1        return(status);                        //·µ»Ø×´Ì¬Öµ
 139   1      }
 140          
 141          // NRF24L01¼Ä´æÆ÷¶Áº¯Êı
 142          // * Èë  ²Î : regaddr:Òª¶ÁÈ¡µÄ¼Ä´æÆ÷µØÖ·              ·µ»ØÖµ : ¶ÁÈ¡µÄ¼Ä´æÆ÷µÄÖµ
 143          uint8 NRF24L01_MA_Read_Reg(uint8 regaddr)
 144          {
 145   1        uint8 reg_val;    
 146   1        CS_MA_LOW;                          //Ê¹ÄÜSPI´«Êä 
 147   1        SPI_RW(regaddr); 
 148   1        reg_val=SPI_RW(0XFF);
 149   1        CS_MA_HIGH;                         //½ûÖ¹SPI´«Êä   
 150   1        return(reg_val);                    //·µ»Ø¶ÁÈ¡µÄÖµ
 151   1      } 
 152          //´ÓÖ¸¶¨µØÖ·¶Á³öÖ¸¶¨³¤¶ÈµÄÊı¾İ
 153          //Èë  ²Î : pBuf:¶Á³öÊı¾İµÄ´æ·ÅµØÖ·£»datlen£º¶Á³öµÄÊı¾İ×Ö½ÚÊı          ·µ»ØÖµ : ¶ÁÈ¡µÄ¼Ä´æÆ÷µÄÖµ
 154          uint8 NRF24L01_MA_Read_Buf(uint8 regaddr,uint8 *pBuf,uint8 datlen)
 155          {
 156   1        uint8 status,u8_ctr;         
 157   1        CS_MA_LOW;                               //Ê¹ÄÜSPI´«Êä
 158   1        status=SPI_RW(regaddr);
 159   1        for(u8_ctr=0;u8_ctr<datlen;u8_ctr++)
 160   1        {
 161   2          pBuf[u8_ctr]=SPI_RW(0XFF);//¶Á³öÊı¾İ
 162   2        }
 163   1        CS_MA_HIGH;                              //¹Ø±ÕSPI´«Êä
 164   1        CS_MA_HIGH;                              //¹Ø±ÕSPI´«Êä
 165   1      
 166   1        return status;                        //·µ»Ø¶Áµ½µÄ×´Ì¬Öµ
 167   1      }
 168          
 169          
 170          //³õÊ¼»¯NRF24L01µ½RXÄ£Ê½£¬ÅäÖÃÏà¹Ø²ÎÊı£¬CE±ä¸ßºó,¼´½øÈëRXÄ£Ê½
 171          void Set_RxMode_MA(void)
 172          {
 173   1        CE_MA_LOW;                        // Delay_1ms(20);
 174   1        NRF24L01_MA_Write_Buf(SPI_WRITE_REG+RX_ADDR_P0,(uint8*)RX_ADDRESS,RX_ADDR_WIDTH); //Ğ´RX½ÚµãµØÖ·
C51 COMPILER V9.59.0.0   NARFL2401                                                         07/16/2024 15:05:21 PAGE 4   

 175   1        NRF24L01_MA_Write_Reg(SPI_WRITE_REG+EN_AA,0x01);  //Ê¹ÄÜÍ¨µÀ0µÄ×Ô¶¯Ó¦´ğ            
 176   1        NRF24L01_MA_Write_Reg(SPI_WRITE_REG+EN_RXADDR,0x01);  //Ê¹ÄÜÍ¨µÀ0µÄ½ÓÊÕµØÖ·   
 177   1        NRF24L01_MA_Write_Reg(SPI_WRITE_REG+RF_CH,55);    //ÉèÖÃRFÍ¨ĞÅÆµÂÊ            
 178   1        NRF24L01_MA_Write_Reg(SPI_WRITE_REG+RX_PW_P0,RX_PLOAD_WIDTH);  //Ñ¡ÔñÍ¨µÀ0µÄÓĞĞ§Êı¾İ¿í¶È 
 179   1        NRF24L01_MA_Write_Reg(SPI_WRITE_REG+RF_SETUP,0x26);  //ÉèÖÃTX·¢Éä²ÎÊı,0dbÔöÒæ,2Mbps,µÍÔëÉùÔöÒæ¿ªÆô   
 180   1        NRF24L01_MA_Write_Reg(SPI_WRITE_REG+CONFIG, 0x0f);                //ÅäÖÃ»ù±¾¹¤×÷Ä£Ê½µÄ²ÎÊı;PWR_UP,EN_CRC
             -,16BIT_CRC,PRIM_RX½ÓÊÕÄ£Ê½ 
 181   1        CE_MA_HIGH;                                                   //CEÎª¸ß,½øÈë½ÓÊÕÄ£Ê½               
 182   1      } 
 183          // Æô¶¯NRF24L01¶ÁÈ¡Ò»´ÎÊı¾İ
 184          //Èë  ²Î : buf:´ı·¢ËÍÊı¾İÊ×µØÖ·     ·µ»ØÖµ : RX_OK£º½ÓÊÕµ½Êı¾İ£»0£ºÎ´½ÓÊÕµ½Êı¾İ
 185          uint8 NRF24L01_RxPacket_MA(uint8 *buf)
 186          {
 187   1        uint8 state;        
 188   1        state=NRF24L01_MA_Read_Reg(STATUS);                //¶ÁÈ¡×´Ì¬¼Ä´æÆ÷µÄÖµ      
 189   1        NRF24L01_MA_Write_Reg(SPI_WRITE_REG+STATUS,state); //Çå³ıTX_DS»òMAX_RTÖĞ¶Ï±êÖ¾
 190   1        if(state&RX_OK)                                    //½ÓÊÕµ½Êı¾İ
 191   1        {
 192   2          NRF24L01_MA_Read_Buf(RD_RX_PLOAD,buf,RX_PLOAD_WIDTH);//¶ÁÈ¡Êı¾İ
 193   2          NRF24L01_MA_Write_Reg(FLUSH_RX,0xff);            //Çå³ıRX FIFO¼Ä´æÆ÷ 
 194   2          return RX_OK; 
 195   2        }    
 196   1         return 0;                                           //Ã»ÊÕµ½ÈÎºÎÊı¾İ
 197   1      }
 198          void zhongduanyi()
 199          {
 200   1        ES=1;
 201   1        IE2 |= 0x01;
 202   1        IE2 |= 0x08;
 203   1        IE2 |= 0x10;
 204   1        
 205   1        IE1  = 0;      //Íâ²¿ÖĞ¶Ï1±êÖ¾Î»
 206   1        EX1 = 1;       //INT1 Enable
 207   1        IT1 = 1;       //INT1 ÏÂ½µÑØÖĞ¶Ï    
 208   1        EA = 1;        //ÔÊĞí×ÜÖĞ¶Ï
 209   1      }
 210          void RF_ReceDat()
 211            {  
 212   1           if(NRF24L01_RxPacket_MA(RxPayload) == RX_OK) //Èç¹û½ÓÊÕµ½Êı¾İ
 213   1             {  
 214   2               cmd=RxPayload[0];
 215   2               RxPayload[0]=0;
 216   2               delay_ms(200);        
 217   2             }    
 218   1       }
 219          //========================================================================
 220          void INT1_int (void) interrupt INT1_VECTOR
 221          {
 222   1        RF_ReceDat();
 223   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    380    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
C51 COMPILER V9.59.0.0   NARFL2401                                                         07/16/2024 15:05:21 PAGE 5   

   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
